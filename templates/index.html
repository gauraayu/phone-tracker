{% extends "base.html" %}
{% block content %}

<h2>üìç Location Tracker Dashboard</h2>

<!-- FORM TO SEND LOCATION REQUEST -->
<form id="sendForm" method="post" action="/send_link">
    <label>Enter phone numbers (comma separated for multiple):</label>
    <input type="text" name="phone" placeholder="e.g. 9876543210, 9123456789" required>
    <button type="submit">Send Location Link</button>
</form>

<!-- MAP -->
<div id="map" style="width:100%; height:500px; margin:20px 0;"></div>
<p id="noLocationsMsg" style="text-align:center; color:yellow; display:none;">No locations shared yet.</p>

<!-- TABLE -->
<table id="locationsTable">
<thead>
<tr><th>Phone</th><th>Latitude</th><th>Longitude</th><th>Status</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>

<script>
let map;
let markers = [];

function initMap() {
    map = new google.maps.Map(document.getElementById('map'), { zoom: 3, center: { lat: 20, lng: 0 } });
    loadLocations();
    setInterval(loadLocations, 15000);
}

function clearMarkers() {
    markers.forEach(marker => marker.setMap(null));
    markers = [];
}

function loadLocations() {
    fetch(`/locations.json`)
        .then(res => res.ok ? res.json() : Promise.reject(res.status))
        .then(data => {
            updateTable(data);
            clearMarkers();
            const bounds = new google.maps.LatLngBounds();
            document.getElementById("noLocationsMsg").style.display = data.length === 0 ? "block" : "none";

            data.forEach(item => {
                if (item.lat && item.lng && item.active) {
                    const marker = new google.maps.Marker({
                        position: { lat: parseFloat(item.lat), lng: parseFloat(item.lng) },
                        map: map,
                        title: `${item.phone}\nLat: ${item.lat}, Lng: ${item.lng}`
                    });
                    const infoWindow = new google.maps.InfoWindow({ content: `<b>${item.phone}</b><br>Lat: ${item.lat}<br>Lng: ${item.lng}` });
                    marker.addListener('click', () => infoWindow.open(map, marker));
                    markers.push(marker);
                    bounds.extend(marker.getPosition());
                }
            });

            if (markers.length) map.fitBounds(bounds);
        })
        .catch(err => console.error("Error loading locations:", err));
}

function updateTable(data) {
    const tbody = document.querySelector('#locationsTable tbody');
    tbody.innerHTML = '';
    data.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.phone}</td>
            <td>${item.lat || '-'}</td>
            <td>${item.lng || '-'}</td>
            <td>${item.active ? 'Active' : 'Stopped'}</td>
            <td>${item.active ? `
                <form method="post" action="/stop_tracking" style="display:inline;">
                    <input type="hidden" name="phone" value="${item.phone}">
                    <button type="submit" style="background:#e74c3c; color:white; border:none; padding:5px 10px; cursor:pointer;">Stop</button>
                </form>
            ` : '-'}</td>
        `;
        tbody.appendChild(row);
    });
}
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>

{% endblock %}
