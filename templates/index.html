{% extends "base.html" %}
{% block content %}

<h2>📍 Location Tracker Dashboard</h2>

<!-- FORM TO SEND LOCATION REQUEST -->
<form id="sendForm" method="post" action="/send_link">
    <label>Enter phone numbers (comma separated for multiple):</label>
    <input type="text" name="phone" placeholder="e.g. 9876543210, 9123456789" required>
    <button type="submit">Send Location Link</button>
</form>

<!-- MAP -->
<div id="map" style="width:100%; height:500px; margin:20px 0;"></div>
<p id="noLocationsMsg" style="text-align:center; color:yellow; display:none;">No locations shared yet.</p>

<!-- TABLE -->
<table id="locationsTable">
<thead>
<tr><th>Phone</th><th>Latitude</th><th>Longitude</th><th>Status</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>

<script>
let map;
let markers = [];

function initMap() {
    map = new google.maps.Map(document.getElementById('map'), { zoom: 3, center: { lat: 20, lng: 0 } });
    loadLocations();
    setInterval(loadLocations, 15000);
}

function clearMarkers() {
    markers.forEach(marker => marker.setMap(null));
    markers = [];
}

function loadLocations() {
    fetch(`/locations.json?key={{ admin_key }}`)
        .then(res => res.ok ? res.json() : Promise.reject(res.status))
        .then(data => {
            clearMarkers();
            const bounds = new google.maps.LatLngBounds();

            data.forEach(item => {
                if (item.lat && item.lng && item.active) {
                    const marker = new google.maps.Marker({
                        position: { lat: parseFloat(item.lat), lng: parseFloat(item.lng) },
                        map: map,
                        title: item.phone
                    });
                    markers.push(marker);
                    bounds.extend(marker.getPosition());
                }
            });

            if (markers.length) map.fitBounds(bounds);
        })
        .catch(err => console.error("Error loading locations:", err));
}

</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>

{% endblock %}
